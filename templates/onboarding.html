{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between mb-4">
  <h2>Personalize Your Recommendations</h2>
  <div>
    <a class="btn btn-outline-secondary me-2" id="dashboardLink" href="/dashboard">Skip to Dashboard</a>
  </div>
</div>

<p class="lead mb-4">Tell us what you like! Rate at least a few movies to get personalized recommendations.</p>

<div id="moviesContainer" class="row"></div>

<div class="text-center mt-4 mb-4">
  <button id="submitBtn" class="btn btn-primary btn-lg" disabled>
    <span id="submitText">Submit Preferences</span>
    <span id="submitCount" class="badge bg-light text-dark ms-2">0</span>
  </button>
  <p class="text-muted mt-2">
    <span id="ratedCount">0</span> movies rated
  </p>
</div>

{% endblock %}

{% block scripts %}
<script>
const userId = new URLSearchParams(window.location.search).get('user_id') || 1;
const responsesMap = {}; // movie_id -> like value (-1, 0, or 1)

// Set dashboard link with user_id
document.getElementById('dashboardLink').href = `/dashboard?user_id=${userId}`;

// Load movies from backend
async function loadMovies() {
  try {
    const res = await fetch('/api/movies/onboarding');
    const data = await res.json();
    const movies = data.movies || [];
    
    if (movies.length === 0) {
      document.getElementById('moviesContainer').innerHTML = 
        '<div class="col-12"><p class="text-muted">No movies available for onboarding.</p></div>';
      return;
    }
    
    const container = document.getElementById('moviesContainer');
    container.innerHTML = '';
    
    movies.forEach(movie => {
      const card = document.createElement('div');
      card.className = 'col-md-4 col-lg-3 mb-4';
      card.innerHTML = `
        <div class="card h-100 movie-card" data-movie-id="${movie.movie_id}">
          <img src="${movie.poster || 'https://via.placeholder.com/300x420?text=' + movie.movie_id}" 
               class="card-img-top poster" 
               alt="${movie.name}"
               style="height: 400px; object-fit: cover;">
          <div class="card-body d-flex flex-column">
            <h6 class="card-title">${movie.name}</h6>
            <p class="text-muted mb-2">${movie.year || 'N/A'}</p>
            <div class="mt-auto">
              <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-sm btn-outline-success like-btn" data-choice="1">
                  <i class="fas fa-thumbs-up"></i> Like
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary neutral-btn" data-choice="0">
                  <i class="fas fa-minus"></i> Neutral
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger dislike-btn" data-choice="-1">
                  <i class="fas fa-thumbs-down"></i> Dislike
                </button>
              </div>
              <div class="mt-2 text-center">
                <small class="text-muted choice-indicator" id="choice-${movie.movie_id}"></small>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add event listeners
      const likeBtn = card.querySelector('.like-btn');
      const neutralBtn = card.querySelector('.neutral-btn');
      const dislikeBtn = card.querySelector('.dislike-btn');
      const choiceIndicator = card.querySelector('.choice-indicator');
      const movieCard = card.querySelector('.movie-card');
      
      function setChoice(choice) {
        // Remove active states
        [likeBtn, neutralBtn, dislikeBtn].forEach(btn => {
          btn.classList.remove('active', 'btn-success', 'btn-secondary', 'btn-danger');
          btn.classList.add('btn-outline-success', 'btn-outline-secondary', 'btn-outline-danger');
        });
        
        // Set new choice
        responsesMap[movie.movie_id] = parseInt(choice);
        
        // Update UI
        if (choice === '1') {
          likeBtn.classList.add('active', 'btn-success');
          likeBtn.classList.remove('btn-outline-success');
          choiceIndicator.textContent = '✓ Liked';
          choiceIndicator.className = 'text-success choice-indicator';
          movieCard.style.border = '3px solid #198754';
        } else if (choice === '0') {
          neutralBtn.classList.add('active', 'btn-secondary');
          neutralBtn.classList.remove('btn-outline-secondary');
          choiceIndicator.textContent = '○ Neutral';
          choiceIndicator.className = 'text-secondary choice-indicator';
          movieCard.style.border = '3px solid #6c757d';
        } else if (choice === '-1') {
          dislikeBtn.classList.add('active', 'btn-danger');
          dislikeBtn.classList.remove('btn-outline-danger');
          choiceIndicator.textContent = '✗ Disliked';
          choiceIndicator.className = 'text-danger choice-indicator';
          movieCard.style.border = '3px solid #dc3545';
        }
        
        updateSubmitButton();
      }
      
      likeBtn.addEventListener('click', () => setChoice('1'));
      neutralBtn.addEventListener('click', () => setChoice('0'));
      dislikeBtn.addEventListener('click', () => setChoice('-1'));
      
      container.appendChild(card);
    });
  } catch (error) {
    console.error('Error loading movies:', error);
    document.getElementById('moviesContainer').innerHTML = 
      '<div class="col-12"><p class="text-danger">Error loading movies. Please refresh the page.</p></div>';
  }
}

// Update submit button state
function updateSubmitButton() {
  const count = Object.keys(responsesMap).length;
  const ratedCountEl = document.getElementById('ratedCount');
  const submitBtn = document.getElementById('submitBtn');
  const submitCountEl = document.getElementById('submitCount');
  
  ratedCountEl.textContent = count;
  submitCountEl.textContent = count;
  
  if (count > 0) {
    submitBtn.disabled = false;
  } else {
    submitBtn.disabled = true;
  }
}

// Submit preferences
async function submitPreferences() {
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
  
  try {
    // Convert responsesMap to array format expected by backend
    const responses = Object.keys(responsesMap).map(movieId => ({
      movie_id: parseInt(movieId),
      like: responsesMap[movieId]
    }));
    
    const res = await fetch('/api/onboarding', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        user_id: parseInt(userId),
        responses: responses
      })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      // Redirect to dashboard with flag indicating onboarding completion
      window.location.href = `/dashboard?user_id=${userId}&from_onboarding=true`;
    } else {
      alert(data.error || 'Error submitting preferences. Please try again.');
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span id="submitText">Submit Preferences</span><span id="submitCount" class="badge bg-light text-dark ms-2">' + Object.keys(responsesMap).length + '</span>';
    }
  } catch (error) {
    console.error('Error submitting preferences:', error);
    alert('Error submitting preferences. Please try again.');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span id="submitText">Submit Preferences</span><span id="submitCount" class="badge bg-light text-dark ms-2">' + Object.keys(responsesMap).length + '</span>';
  }
}

// Initialize
document.getElementById('submitBtn').addEventListener('click', submitPreferences);
loadMovies();
</script>

<style>
.movie-card {
  transition: transform 0.2s, box-shadow 0.2s;
}

.movie-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.poster {
  border-radius: 8px 8px 0 0;
}

.btn-group .btn.active {
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

.choice-indicator {
  font-weight: bold;
  font-size: 0.9rem;
}
</style>
{% endblock %}
