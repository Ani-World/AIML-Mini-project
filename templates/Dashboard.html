{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between mb-3">
  <h3>Top Picks for you</h3>
  <div>
    <a class="btn btn-outline-secondary me-2" id="archiveLink" href="/archive">Your Archive</a>
    <a class="btn btn-sm btn-light" id="logoutBtn">Logout</a>
  </div>
</div>

<!-- stats row -->
<!-- <div class="row mb-3">
  <div class="col-md-3 stat-box">
    <h6>Total watch time</h6>
    <div id="totalWatchTime" class="fs-4">—</div>
    <small class="text-muted">minutes</small>
  </div>
  <div class="col-md-3 stat-box">
    <h6>Movies rated</h6>
    <div id="moviesRated" class="fs-4">—</div>
  </div>
  <div class="col-md-6 stat-box">
    <h6>Genre distribution</h6>
    <canvas id="genreChart" style="max-height:140px"></canvas>
  </div>
</div> -->

<!-- Carousels -->
<section>
  <h5>Top picks for you</h5>
  <div id="topPicks" class="carousel-row"></div>
</section>

<section class="mt-4">
  <h5>Because you liked ...</h5>
  <div id="becauseYouLiked" class="carousel-row"></div>
</section>

<section class="mt-4">
  <h5>Similar to your favorites</h5>
  <div id="similarCluster" class="carousel-row"></div>
</section>

<!-- Onboarding Button -->
<button id="onboardingBtn" class="btn btn-success mb-3">
  Personalize My Recommendations
</button>


<!-- Onboarding modal (first visit) -->
<div class="modal fade" id="onboardModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Tell us what you like — tap Like / Neutral / Dislike</h5></div>
      <div class="modal-body">
        <div id="onboardTiles" class="d-flex flex-wrap"></div>
      </div>
      <div class="modal-footer">
        <button id="submitOnboard" class="btn btn-primary">Save & Get Recommendations</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Get user_id from URL - required for proper user-specific recommendations
const urlParams = new URLSearchParams(window.location.search);
let userId = urlParams.get('user_id');
if (!userId || userId === 'null' || userId === 'undefined') {
  // If no user_id, redirect to login
  console.error('user_id is required for dashboard');
  alert('User ID is required. Redirecting to login...');
  window.location.href = '/login';
} else {
  userId = parseInt(userId);
}

// Utility to create movie card
function movieCard(movie) {
  const div = document.createElement('div');
  div.className = 'card card-movie';
  const movieUrl = userId ? `/movie/${movie.movie_id}?user_id=${userId}` : `/movie/${movie.movie_id}`;
  div.innerHTML = `
    <img src="${movie.poster}" class="poster" />
    <div class="p-2">
      <h6 class="mb-0">${movie.Name}</h6>
      <small class="text-muted">${movie.Year}</small>
      <div class="mt-1 d-flex justify-content-between align-items-center">
        <a class="btn btn-sm btn-outline-primary" href="${movieUrl}">Open</a>
        <span class="badge bg-light text-dark">${(movie.hybrid_score||0).toFixed(2)}</span>
      </div>
    </div>
  `;
  return div;
}

// load recommendations (with optional refresh flag to force reload from DB)
async function loadRecommendations(refresh = false) {
  //const refreshParam = refresh ? '&refresh=true' : '';
  const refreshParam = '&refresh=true';
  const url = `/api/recommendations?user_id=${userId}&n=12${refreshParam}`;
  console.log('Loading recommendations from:', url);
  const res = await fetch(url);
  const json = await res.json();
  const items = json.recommendations || [];
  console.log(`Received ${items.length} recommendations`);
  document.getElementById('topPicks').innerHTML = '';
  if (items.length === 0) {
    document.getElementById('topPicks').innerHTML = '<p class="text-muted">No recommendations available yet. Rate some movies to get personalized recommendations!</p>';
  } else {
    items.forEach(m => document.getElementById('topPicks').appendChild(movieCard(m)));
  }
}

// load cluster / because-you-liked from same endpoint
async function loadExtras(refresh = false) {
  const refreshParam = refresh ? '&refresh=true' : '';
  // Add a small delay and different offset to get different recommendations
  // This ensures "Because you liked" and "Similar cluster" show different movies
  const offset = refresh ? Math.floor(Math.random() * 5) : 0;
  const res = await fetch(`/api/recommendations?user_id=${userId}&n=18${refreshParam}`);
  const items = (await res.json()).recommendations || [];
  document.getElementById('becauseYouLiked').innerHTML = '';
  document.getElementById('similarCluster').innerHTML = '';
  if (items.length === 0) {
    document.getElementById('becauseYouLiked').innerHTML = '<p class="text-muted">No recommendations yet.</p>';
    document.getElementById('similarCluster').innerHTML = '<p class="text-muted">No recommendations yet.</p>';
  } else {
    // Use different slices to show different movies in each section
    items.slice(offset, offset+6).forEach(m => document.getElementById('becauseYouLiked').appendChild(movieCard(m)));
    items.slice(offset+6, offset+12).forEach(m => document.getElementById('similarCluster').appendChild(movieCard(m)));
  }
}

// onboarding: fetch movies list and show 20 tiles
async function showOnboarding() {
  const res = await fetch('/api/movies/onboarding');
  const data = await res.json();
  const movies = data.movies.slice(0,20);
  const tiles = document.getElementById('onboardTiles');
  tiles.innerHTML = '';
  movies.forEach(m => {
    const card = document.createElement('div');
    card.className = 'card card-movie';
    card.innerHTML = `
      <img src="${m.poster || 'https://via.placeholder.com/300x420'}" class="poster" />
      <div class="p-2 text-center">
        <div class="mb-1"><strong>${m.name}</strong></div>
        <div>
          <button class="btn btn-sm btn-outline-success like">Like</button>
          <button class="btn btn-sm btn-outline-secondary neutral">Neutral</button>
          <button class="btn btn-sm btn-outline-danger dislike">Dislike</button>
        </div>
      </div>`;
    // track state
    card.dataset.movieId = m.movie_id;
    card.dataset.choice = 0;
    card.querySelector('.like').addEventListener('click', ()=> { card.dataset.choice = 1; card.style.border='3px solid #0d6efd'; });
    card.querySelector('.neutral').addEventListener('click', ()=> { card.dataset.choice = 0; card.style.border='3px solid #6c757d'; });
    card.querySelector('.dislike').addEventListener('click', ()=> { card.dataset.choice = -1; card.style.border='3px solid #dc3545'; });
    tiles.appendChild(card);
  });
  const modal = new bootstrap.Modal(document.getElementById('onboardModal'));
  modal.show();

  document.getElementById('submitOnboard').onclick = async () => {
    const responses = Array.from(tiles.children).map(c => ({ movie_id: c.dataset.movieId, like: parseInt(c.dataset.choice) }));
    const r = await fetch('/api/onboarding', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ user_id: userId, responses })
    });
    const jr = await r.json();
    modal.hide();
    // Refresh recommendations with updated preferences
    await refreshDashboard();
    alert(jr.message || 'Onboarding saved');
  };
}

// // Load analytics (watch time, genre distribution, etc.)
// async function loadAnalytics(refresh = false) {
//   try {
//     const refreshParam = refresh ? '&refresh=true' : '';
//     const url = `/api/user/analytics?user_id=${userId}${refreshParam}`;
//     console.log('Loading analytics from:', url);
//     const res = await fetch(url);
//     const json = await res.json();
//     console.log('Analytics loaded:', json);
    
//     // Total watch time
//     const totalHours = json.total_watch_time_hours || 0;
//     const totalMinutes = json.total_watch_time || 0;
//     document.getElementById('totalWatchTime').innerText = totalHours > 0 
//       ? `${totalHours.toFixed(1)} hrs` 
//       : `${totalMinutes} min`;
    
//     // Movies rated
//     document.getElementById('moviesRated').innerText = json.movies_rated || 0;

//     // Genre distribution chart
//     const genreData = json.genre_distribution || [];
//     if (genreData.length > 0) {
//       const labels = genreData.slice(0, 8).map(g => g.genre);
//       const data = genreData.slice(0, 8).map(g => g.count);
      
//       const ctx = document.getElementById('genreChart').getContext('2d');
//       if(window.genreChart) window.genreChart.destroy();
//       window.genreChart = new Chart(ctx, {
//         type: 'pie',
//         data: { 
//           labels, 
//           datasets: [{ 
//             data, 
//             backgroundColor: [
//               '#4e79a7','#f28e2b','#e15759','#76b7b2',
//               '#59a14f','#edc949','#b07aa1','#ff9da7'
//             ] 
//           }] 
//         },
//         options: {
//           responsive: true,
//           maintainAspectRatio: true,
//           plugins: {
//             legend: {
//               position: 'bottom',
//               labels: { boxWidth: 12, fontSize: 10 }
//             }
//           }
//         }
//       });
//     } else {
//       document.getElementById('genreChart').innerHTML = '<p class="text-muted">No genre data yet</p>';
//     }
//   } catch(e) {
//     console.error('Error loading analytics:', e);
//     // Don't reset to 0, just leave the current value or show error
//     document.getElementById('totalWatchTime').innerText = '—';
//     document.getElementById('moviesRated').innerText = '—';
//   }
// }

// Refresh all dashboard data (used after onboarding)
async function refreshDashboard() {
  console.log('Refreshing dashboard for user:', userId);
  // Show loading state
  const topPicksEl = document.getElementById('topPicks');
  const becauseEl = document.getElementById('becauseYouLiked');
  const similarEl = document.getElementById('similarCluster');
  
  topPicksEl.innerHTML = '<p class="text-muted">Loading personalized recommendations from ML model...</p>';
  becauseEl.innerHTML = '';
  similarEl.innerHTML = '';
  
  try {
    // Reload all data with refresh flag to force reload from database
    console.log('Loading recommendations with refresh=true...');
    await Promise.all([
      loadRecommendations(true),  // Force refresh from DB
      loadExtras(true),           // Force refresh from DB
      loadAnalytics(true)         // Force refresh from DB
    ]);
    console.log('Dashboard refresh complete');
  } catch (error) {
    console.error('Error refreshing dashboard:', error);
    alert('Error refreshing recommendations. Please try again.');
  }
  
  // Show success message if coming from onboarding
  const currentUrlParams = new URLSearchParams(window.location.search);
  if (currentUrlParams.get('from_onboarding') === 'true') {
    // Remove the parameter from URL
    window.history.replaceState({}, '', window.location.pathname + `?user_id=${userId}`);
    
    // Show a brief success message
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show';
    alertDiv.innerHTML = `
      <strong>Preferences saved!</strong> Your recommendations have been personalized based on your preferences.
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }
}

// Handle Personalize My Recommendations button click
document.getElementById('onboardingBtn').addEventListener('click', () => {
  // Navigate to onboarding page with user_id
  window.location.href = `/onboarding?user_id=${userId}`;
});

// Initial load
(async ()=>{
  // Set archive link with user_id
  document.getElementById('archiveLink').href = `/archive?user_id=${userId}`;
  
  // Check if coming from onboarding
  const fromOnboarding = urlParams.get('from_onboarding') === 'true';
  
  // Load dashboard data
  await Promise.all([
    loadRecommendations(),
    loadExtras(),
    loadAnalytics()
  ]);

  // If coming from onboarding, refresh to show updated recommendations
  if (fromOnboarding) {
    await refreshDashboard();
  } else {
    // show onboarding only if user has no ratings
    const r = await fetch(`/api/user/archive?user_id=${userId}`);
    const jr = await r.json();
    if((jr.archive || []).length === 0) {
      await showOnboarding();
    }
  }
})();

// Logout button
document.getElementById('logoutBtn')?.addEventListener('click', () => {
  window.location.href = '/';
});
</script>
{% endblock %}
